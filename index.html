<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa con GeoTIFF</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map { height: 100vh; width: 100vw; }
    </style>
</head>
<body> 
    <div id="map"></div>

    <!-- Scripts de Leaflet y la versión local de geotiff.js -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="geotiff.min.js"></script> <!-- Cambia esta ruta según tu estructura -->

    <script>
        async function loadGeoTIFFOverlay() {
            // Cargar el archivo GeoTIFF (asegúrate de que el archivo esté accesible y en la misma ruta)
            const response = await fetch('Mapa aereo 50cm.tif'); // Ajusta la ruta si es necesario
            const arrayBuffer = await response.arrayBuffer();
            const tiff = await GeoTIFF.fromArrayBuffer(arrayBuffer);
            const image = await tiff.getImage();

            // Obtener las coordenadas georreferenciadas (bounding box)
            const [xMin, yMax, xMax, yMin] = image.getBoundingBox();
            const corners = [
                [yMin, xMin], // Esquina Inferior Izquierda
                [yMax, xMax]  // Esquina Superior Derecha
            ];

            // Inicializar el mapa en el centro de la imagen
            const map = L.map('map').setView([(yMin + yMax) / 2, (xMin + xMax) / 2], 13);

            // Agregar capa base de OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Crear una URL de imagen de GeoTIFF utilizando canvas
            const rasterData = await image.readRasters();
            const width = image.getWidth();
            const height = image.getHeight();
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            const imgData = ctx.createImageData(width, height);

            for (let i = 0; i < rasterData[0].length; i++) {
                imgData.data[i * 4] = rasterData[0][i];       // Rojo
                imgData.data[i * 4 + 1] = rasterData[1][i];   // Verde
                imgData.data[i * 4 + 2] = rasterData[2][i];   // Azul
                imgData.data[i * 4 + 3] = 255;                // Opacidad
            }
            ctx.putImageData(imgData, 0, 0);
            const imageUrl = canvas.toDataURL();

            // Agregar la imagen como superposición en el mapa
            L.imageOverlay(imageUrl, corners).addTo(map);

            // Ajustar el mapa a los límites de la imagen
            map.fitBounds(corners);
        }

        // Cargar la superposición GeoTIFF
        loadGeoTIFFOverlay();
    </script>
</body>
</html>
